# VIBECODER-SECURE MCP - CI/CD Pipeline
name: ðŸŽ¯ Vibecoder CI/CD Pipeline

'on':
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate:
    name: ðŸ” Validate & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ” Validate project integrity
      run: |
        python main.py validate . --fast
        
    - name: ðŸ§¹ Auto-heal any issues
      run: |
        python main.py heal .
        
    - name: âœ… Generate documentation
      run: |
        python main.py generate .
        
    - name: ðŸ“Š Run monitoring checks
      run: |
        python -c "from src.agents.monitoring import VibecoderMonitor; monitor = VibecoderMonitor('.'); status = monitor.get_real_time_status(); print('Health:', status['project_health']['status'])"
        
    - name: ðŸŽ¯ Check Vibecoder roadmap
      run: |
        python -c "from src.agents.vibecoder_roadmap import get_current_vibecoder_focus; focus = get_current_vibecoder_focus('.'); print('Sprint:', focus['current_sprint'])"
        
    - name: ðŸ“‹ Visual roadmap generation
      run: |
        python -c "from src.agents.visual_roadmap import generate_visual_roadmap; print(generate_visual_roadmap('.', 'progress'))"

  build:
    name: ðŸ³ Build & Push Container
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ” Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix=sha-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: ðŸ”¨ Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Create deployment config
      run: |
        cat > deploy-config.yml << EOF
        version: '3.8'
        services:
          vibecoder-mcp:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            container_name: vibecoder-secure-mcp-prod
            ports:
              - "8000:8000"
            environment:
              - VIBECODER_ENV=production
              - PYTHONUNBUFFERED=1
            volumes:
              - vibecoder_prod_data:/app/.goldminer
              - vibecoder_prod_docs:/app/docs
              - vibecoder_prod_logs:/app/logs
            restart: unless-stopped
            healthcheck:
              test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
              interval: 30s
              timeout: 10s
              retries: 3
              start_period: 40s
        volumes:
          vibecoder_prod_data:
          vibecoder_prod_docs:
          vibecoder_prod_logs:
        EOF
        
    - name: ðŸ“¤ Upload deployment config
      uses: actions/upload-artifact@v3
      with:
        name: deployment-config
        path: deploy-config.yml
        
    - name: âœ… Deployment ready
      run: |
        echo "ðŸŽ¯ VIBECODER-SECURE MCP ready for deployment!"
        echo "ðŸ“Š Container image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "ðŸš€ Use deploy-config.yml for production deployment"

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ðŸ“¤ Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  notification:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [validate, build, deploy, security-scan]
    if: always()
    
    steps:
    - name: ðŸŽ¯ Vibecoder Deployment Status
      run: |
        echo "ðŸŽ¯ VIBECODER-SECURE MCP CI/CD Pipeline Complete!"
        echo "âœ… Validation: ${{ needs.validate.result }}"
        echo "ðŸ³ Build: ${{ needs.build.result }}"
        echo "ðŸš€ Deploy: ${{ needs.deploy.result }}"
        echo "ðŸ”’ Security: ${{ needs.security-scan.result }}"
        echo ""
        echo "ðŸ“Š Ready for production use!"
        echo "ðŸŽ¯ All Vibecoder milestones operational"